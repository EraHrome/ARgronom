@using ARgronom.Models.ViewModels;
@using System.Security.Claims;
@using ARgronom.Contexts;
@using ARgronom.Models;
@using System.Linq;

@using Microsoft.AspNetCore.Identity
@inject SignInManager<IdentityUser> SignInManager
@inject UserManager<IdentityUser> UserManager
@inject Context context

@model ArViewModel

@{
    Layout = null;
    var roleType = Role.None;
    var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);
    if (userId != null)
    {
        var role = context.Roles.FirstOrDefault(x => x.UserId == userId);
        if (role != null)
        {
            roleType = role.Role;
        }
    }
}

@{
    ViewData["Title"] = "AR";
}

<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Location Based AR.js demo</title>
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    <script>

        function createAndAppendMarker(latitude, longitude) {
            let marker = createMarker(position.coords.latitude, position.coords.longitude);
			document.querySelector('a-scene').appendChild(marker);
        }

        function createMarker(latitude, longitude) {
            let marker = document.createElement('a-text');
		    marker.setAttribute('value', 'Tomatos');
		    marker.setAttribute('scale', '3 3 3');
		    marker.setAttribute('look-at', '[gps-camera]');
		    marker.setAttribute('gps-entity-place', `latitude: ${position.coords.latitude}; longitude: ${position.coords.longitude};`);
            return marker;
        }

      window.onload = () => {
	  
        @foreach(var m in Model.Markers)
        {
            <text>
                createAndAppendMarker(@m.Latitude, @m.Longitude);
            </text>
        }

        document.querySelector('html').addEventListener('click', (ev) => {
            console.log('test!');

			navigator.geolocation.getCurrentPosition((position) => {
                createAndAppendMarker(position.coords.latitude, position.coords.longitude);
                window.location.href = `/Ar/AddCoord/?latit=${position.coords.latitude}&longit=${position.coords.longitude}&plantId=${@Model.PlantId}`;
			});
		});
	  
     }
    </script>
  </head>

  <body style="margin: 0; overflow: hidden;">
    <a-scene
      vr-mode-ui="enabled: false;"
      embedded
      arjs="sourceType: webcam; debugUIEnabled: true;"
    >
      <a-text
        value="Cucumbers"
        look-at="[gps-camera]"
        scale="3 3 3"
      ></a-text>
      <a-camera gps-camera='gpsMinDistance: 1;' rotation-reader> </a-camera>
    </a-scene>
  </body>
</html>